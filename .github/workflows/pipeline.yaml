name: CI/CD Pipeline - Menjaro project

on:
  push: 
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3 
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Django tests
        run: |
          cd project_jc
          python3 manage.py migrate
          python3 manage.py makemigrations
          python3 manage.py test app1.tests.AutomatedTests.test_baixar_pdf
        env:
          PYTHONUNBUFFERED: 1
          DJANGO_SETTINGS_MODULE: project_jc.settings

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to EC2
        run: |
          # Criar arquivo com chave SSH
          cat > private_key.pem << 'EOF'
          -----BEGIN RSA PRIVATE KEY-----
          MIIEogIBAAKCAQEAuSU/iRK7BQdCqz9V9mHbYDtTo5VSl4hZqjRFsAzr4tOA6uyT
          ZXpnwgXDZecTyu1hn2ayFtpm3Da/MoraWetLwj7q0wVrltMxIOFRFHsw227Fk8rh
          dmjm5mdJghJ0xauNLxlV4kVMSDQ5b3rqFNG1tAbKdCC4BTVuGWpGyCGdm0EkpiPE
          GgsXlNUIkr3LKrzMKEe8zfGcokx+34MAsVrNqy37ysYMxem8AnfENGbvP7V4ZLoq
          1kB2CEWlzamV/oLf6Z8bGpconWDi9kyZqKoKqdRIHN5V6SJj/45Kz6XwsepeP9pN
          FtfnIaSECCvhH/v2/OAJpNahRN69UOsfGqKvRQIDAQABAoH/b1/42HxsBJpZgKqZ
          C53SWhFWPxGUnZNoXPsU8NLVE54n7yphgKohwJW29ZYMUgZ6s2kTuKupNM+6NK1S
          rMTezfsLR+X60sA4zY69N5TjzxzTvhRNjO2N+QwpLBXuKPsJ80tKXtNREB5abrWC
          GwQMSj/LihAkov2BPciwy7NtG/cOJcA/GB4co3SYJ84p3szgpu5axYS17LWnAljG
          uL67T5Kz/Sq4obqLLXPA7Pi9cL0Yw+25t8VbG3J2rYJi6f/+Jz+YlhKtLm3blzt5
          QGVh1eEIOZ7kvKQ/ifyhp3qWOO/t9KmZxKi9YBx1H59QtVRko3ecVPV/HaAEn5kq
          E7yBAoGBANq7fgkDfU6Xo7wtNSEQwUC0vqUr8AyOfCkmPIe6ZmeKGCYibS4M6GyI
          nNWMS+6mER/EIHvb2Fu40zkihtGCvUwTP8O0V+TNXtnChLoA/Ah7Pl7V3ZMW0SVh
          Ag+rXoPeZyG/oB3jAsegk4fWgqvE2qwm8Fj5+mTsJ9daw8/5FOn1AoGBANiwyaW8
          LrB1maN8JGTSj+lz2okqh2kbbUw3nUVRhETKIxw0Mx4562iRIob2sSsi0f+vhOto
          9UdlYoO7zeGzpiXeSHw+5rlqbgXYM9GNTIob3ZyjAjnqXOfgpouH1fxIquFAEwaX
          JBIl4rel5FK6eTpD4fok7STzHBQYCb1ijM4RAoGBAIQ4UjegpF6dy5w0t6kFN8yl
          dZjitnjgqK03L9/cDYsJLw/eP6FWrCjva96qsDvSpwdMx1YXzvGjCAvBkz2Silsy
          R5lFqtvkSTHZI+JMNg3qcglhvk7rvAGcYmKWdMvB5RXBgEiQsV1687NpOBQdKxJl
          d2RRt8rJ9kt30mYlaz8BAoGAQ7RxPPygZfhIqgE26d20o4/UX3lPV/L+4oqZ9De1
          KT0zXTOeKTqVqFV4wUzBLKYzkT1JPbjMsqMl9d0vRe844aojYdbRhmuPtvnHrxkE
          Kj7srm1sW6YzoyvZPc2SecJGyhyYFT4SQi1eOl12CrdC+4aMS/lPs3TWeBzOpkLt
          ldECgYEAyLDoiUcyHW5VouyNjrKgq29Ouw9MMaS4R3dEWEgZG0bMzpKlVPnRKkjl
          Iqam/O6RrIoZ0Gx5NDtFi2zO36mefW3cjfRPvK4Xp7W0bFU5qi/iYw6RYgveIo2a
          7eldatCjbpLtrO8EM8lwzO3bQCttv2i+2TAW2mkxV5QYQ3StdCw=
          -----END RSA PRIVATE KEY-----
          EOF
          
          chmod 600 private_key.pem
          
          echo "ğŸš€ Conectando ao servidor EC2..."
          ssh -o StrictHostKeyChecking=no -i private_key.pem ubuntu@18.118.34.118 '
           set -e  # Para no primeiro erro

          echo "ğŸ“‚ Navegando para o projeto..."
          cd projetos_2/menjaro
          ls

          echo "â¬‡ï¸ Atualizando cÃ³digo..."
          git fetch --all
          git reset --hard origin/main

          echo "ğŸ“¦ Ativando ambiente virtual..."
          source venv/bin/activate
          cd project_jc

          python3 manage.py makemigrations 
          python3 manage.py migrate
          sudo lsof -t -i:8000 | xargs -r sudo kill -9
          nohup python3 manage.py runserver 0.0.0.0:8000 > django.log 2>&1 &

          echo "ğŸš€ AplicaÃ§Ã£o reiniciada com sucesso na porta 8000!"
          echo "ğŸ“Œ Para visualizar:"
          echo "     screen -r deploy_session"  
          echo "     ps -aux | grep python"

          '
          
          # Limpar chave SSH
          rm -f private_key.pem
          
          echo "ğŸ‰ Pipeline finalizada!"
      
      - name: Verify deployment
        run: |
          echo "â³ Aguardando serviÃ§o iniciar..."
          sleep 5
          
          echo "ğŸ” Testando se aplicaÃ§Ã£o estÃ¡ respondendo..."
          # Ajuste a URL conforme necessÃ¡rio
          # curl -f http://18.118.34.118 || echo "âš ï¸ AplicaÃ§Ã£o nÃ£o estÃ¡ respondendo ainda"