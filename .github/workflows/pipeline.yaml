name: CI/CD Pipeline - Menjaro project

on:
  push: 
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3 
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Django tests
        run: |
          cd project_jc
          python3 manage.py migrate
          python3 manage.py makemigrations
          python3 manage.py test app1.tests.AutomatedTests.testE2E_COMPLETO
        env:
          PYTHONUNBUFFERED: 1
          DJANGO_SETTINGS_MODULE: project_jc.settings

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
    
      - name: Configure SSH key
        run: |
          # Criar arquivo com chave SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/ec2.key
          chmod 600 ~/.ssh/ec2.key
          echo "StrictHostKeyChecking no" > ~/.ssh/config

      - name: Deploy to EC2
        run: |  
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2.key ubuntu@18.118.34.118 '
            echo "ğŸš€ Conectando ao servidor EC2..."
            set -e  # Para no primeiro erro

            echo "ğŸ“‚ Navegando para o projeto..."
            cd projetos_2/menjaro
            ls

            echo "â¬‡ï¸ Atualizando cÃ³digo..."
            git fetch --all
            git reset --hard origin/main

            echo "ğŸ“¦ Ativando ambiente virtual..."
            source venv/bin/activate
            
            echo "Verificando libs do projeto"
            pip install -r requirements.txt
            cd project_jc

            python3 manage.py makemigrations 
            python3 manage.py migrate
            sudo lsof -t -i:8000 | xargs -r sudo kill -9
            nohup python3 manage.py runserver 0.0.0.0:8000 > django.log 2>&1 &

            echo "ğŸš€ AplicaÃ§Ã£o reiniciada com sucesso na porta 8000!"
            echo "ğŸ“Œ Para visualizar:"
            echo "     screen -r deploy_session"  
            echo "     ps -aux | grep python"

            '
            
            # Limpar chave SSH
            rm -f private_key.pem
            
            echo "ğŸ‰ Pipeline finalizada!"
      
      - name: Verify deployment
        run: |
          echo "â³ Aguardando serviÃ§o iniciar..."
          sleep 5
          
          echo "ğŸ” Testando se aplicaÃ§Ã£o estÃ¡ respondendo..."
          # Ajuste a URL conforme necessÃ¡rio
          # curl -f http://18.118.34.118 || echo "âš ï¸ AplicaÃ§Ã£o nÃ£o estÃ¡ respondendo ainda"